<?xml version="1.0" encoding="UTF-8"?>
<project name="as3gnuTasks" basedir="." default="all">

	<!-- Properties -->

	<property name="src.dir" value="src"/>
    <property name="bin.dir" value="bin"/>
    <property name="lib.name" value="${ant.project.name}.jar"/>
    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="lib.out" value="${lib.dir}/${lib.name}"/>
    
    <property name="version.major" value="0" />
    <property name="version.minor" value="8" />
    <property name="version" value="${version.major}.${version.minor}" />
	
	<available file="${lib.out}" property="lib.available" />
	
	<!-- cleans files generated by this build file -->
	
    <target name="clean" description="Delete all generated files">
        <delete dir="${bin.dir}"/>
        <delete dir="${lib.dir}"/>
        <delete file="${src.dir}/library-project/${ant.project.name}.jar" />
        <delete file="${src.dir}/library-project/${ant.project.name}.tasks" />
        <delete file="${src.dir}/app-project/${ant.project.name}.jar" />
        <delete file="${src.dir}/app-project/${ant.project.name}.tasks" />
    </target>
    
    <!-- builds the program -->

    <target name="all" description="Compiles the tasks">
		<mkdir dir="${bin.dir}" />
        <javac srcdir="${src.dir}/tasks" destdir="${bin.dir}">
			<compilerarg value="-Xlint:unchecked" />
		</javac>
		<mkdir dir="${lib.dir}" />
        <jar destfile="${lib.out}"> 
			<fileset dir="${bin.dir}"/>
			<manifest>
				<attribute name="Built-By" value="Ant ${ant.version}"/>
				<attribute name="Implementation-Vendor" value="Vincent Petithory"/>
				<attribute name="Implementation-Title" value="${ant.project.name}"/>
				<attribute name="Implementation-Version" value="${version}"/>
			</manifest>
		</jar>
		<copy file="${src.dir}/tasks/${ant.project.name}.tasks" toDir="${lib.dir}" />
		
		<!-- copy files in project templates -->
		<copy file="${lib.dir}/${ant.project.name}.tasks" toDir="${src.dir}/library-project" />
		<copy file="${lib.out}" toDir="${src.dir}/library-project" />
		<copy file="${lib.dir}/${ant.project.name}.tasks" toDir="${src.dir}/app-project" />
		<copy file="${lib.out}" toDir="${src.dir}/app-project" />
		
		<!-- zip project templates and copy them in lib -->
		<tar destfile="${lib.dir}/library-project.tar" >
			<tarfileset 
				dir="${src.dir}/library-project" 
				prefix="library-project" 
			/>
		</tar>
		<gzip destfile="${lib.dir}/library-project.tar.gz" src="${lib.dir}/library-project.tar"/>
		<delete file="${lib.dir}/library-project.tar" />
		
		<tar destfile="${lib.dir}/app-project.tar" >
			<tarfileset 
				dir="${src.dir}/app-project" 
				prefix="app-project" 
			/>
		</tar>
		<gzip destfile="${lib.dir}/app-project.tar.gz" src="${lib.dir}/app-project.tar"/>
		<delete file="${lib.dir}/app-project.tar" />
		
    </target>
    
    <!-- Makes a distribution file -->
	
	<target name="distclean" description="Delete all generated files that are not part of the distribution">
    	<antcall target="clean" />
	</target>
	
    <target name="dist" description="Makes a distribution file">
		<property name="basename" value="${ant.project.name}-${version}" />
		<tar destfile="${basedir}/${basename}.tar" >
			<tarfileset 
				dir="." 
				prefix="${basename}" 
				excludes=".git/**,.gitignore,*.tar.gz,bin/**,lib/**"
			/>
		</tar>
		<gzip destfile="${basedir}/${basename}.tar.gz" src="${basedir}/${basename}.tar"/>
		<delete file="${basedir}/${basename}.tar" />
    </target>
	
</project>
